<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>📦 Cubic Box Simulator - Pallet & Truck Calculator</title>
  <style>
:root {
  --primary: #4c6ef5;
  --primary-dark: #364fc7;
  --secondary: #20c997;
  --light-bg: #f8f9fa;
  --dark-bg: #181c20;
  --light-card: #fff;
  --dark-card: #23272c;
  --border: #ced4da;
  --stroke: #212529;
  --dimline: #2095ff;
  --shadow: 0 2px 8px rgba(34,51,68,0.15);
  --radius: 8px;
  --trans: all 0.2s ease;
  --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

[data-theme="dark"] {
  --light-bg: #181c20;
  --light-card: #23272c;
  --border: #394048;
  --stroke: #e9ecef;
  --shadow: 0 2px 8px rgba(0,0,0,0.3);
}

* { box-sizing: border-box; }
body {
  margin: 0; padding: 0;
  font-family: var(--font-main);
  background: var(--light-bg);
  color: #2d3748;
  line-height: 1.6;
  transition: var(--trans);
}

[data-theme="dark"] body {
  background: var(--dark-bg);
  color: #f7fafc;
}

/* Layout */
.container {
  display: flex;
  min-height: 100vh;
}

@media (max-width: 900px) {
  .container { flex-direction: column; }
}

.sidebar {
  width: 380px;
  background: var(--light-card);
  padding: 24px;
  box-shadow: var(--shadow);
  border-right: 1px solid var(--border);
  overflow-y: auto;
  transition: var(--trans);
}

[data-theme="dark"] .sidebar {
  background: var(--dark-card);
}

@media (max-width: 900px) {
  .sidebar {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid var(--border);
  }
}

.main {
  flex: 1;
  padding: 24px;
  background: var(--light-bg);
  overflow-y: auto;
  transition: var(--trans);
}

[data-theme="dark"] .main {
  background: var(--dark-bg);
}

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}

.header h1 {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
  color: var(--primary);
}

.theme-toggle {
  background: var(--light-card);
  border: 1px solid var(--border);
  border-radius: 50%;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.2rem;
  transition: var(--trans);
}

.theme-toggle:hover {
  background: var(--primary);
  color: white;
}

/* Form Groups */
.form-group {
  margin-bottom: 1.8rem;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: #4a5568;
}

[data-theme="dark"] .form-group label {
  color: #cbd5e0;
}

/* Input Styles */
.input-group {
  position: relative;
}

.form-control {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--light-card);
  font-size: 1rem;
  transition: var(--trans);
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(76, 110, 245, 0.1);
}

[data-theme="dark"] .form-control {
  background: var(--dark-card);
  color: #f7fafc;
  border-color: #4a5568;
}

/* Dropdown with Icons */
.dropdown-group {
  position: relative;
}

.dropdown-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 8px;
  margin-top: 8px;
}

.dropdown-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px 8px;
  border: 2px solid var(--border);
  border-radius: var(--radius);
  background: var(--light-card);
  cursor: pointer;
  transition: var(--trans);
  text-align: center;
}

.dropdown-option:hover {
  border-color: var(--primary);
  background: rgba(76, 110, 245, 0.05);
}

.dropdown-option.active {
  border-color: var(--primary);
  background: rgba(76, 110, 245, 0.1);
}

.dropdown-option .icon {
  font-size: 1.8rem;
  margin-bottom: 4px;
}

.dropdown-option .label {
  font-size: 0.85rem;
  font-weight: 600;
}

.dropdown-option .size {
  font-size: 0.75rem;
  color: #718096;
  margin-top: 2px;
}

/* Custom Input Row */
.input-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 8px;
}

.input-row input {
  flex: 1;
  min-width: 60px;
}

.input-row .unit {
  color: #718096;
  font-weight: 500;
}

/* Checkbox & Radio */
.checkbox-group, .radio-group {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 8px 0;
}

.checkbox-group input, .radio-group input {
  width: auto;
}

/* Box Preview */
.box-preview {
  width: 100%;
  height: 120px;
  background: linear-gradient(45deg, #f7fafc 25%, transparent 25%),
              linear-gradient(-45deg, #f7fafc 25%, transparent 25%),
              linear-gradient(45deg, transparent 75%, #f7fafc 75%),
              linear-gradient(-45deg, transparent 75%, #f7fafc 75%);
  background-size: 10px 10px;
  background-position: 0 0, 0 5px, 5px -5px, -5px 0px;
  border-radius: var(--radius);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 16px 0;
  position: relative;
  overflow: hidden;
}

.box-3d {
  position: relative;
  transform-style: preserve-3d;
  transition: var(--trans);
}

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 24px;
  border: none;
  border-radius: var(--radius);
  font-weight: 600;
  cursor: pointer;
  transition: var(--trans);
  text-decoration: none;
  gap: 8px;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--secondary);
  color: white;
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: #4a5568;
}

[data-theme="dark"] .btn-outline {
  color: #cbd5e0;
  border-color: #4a5568;
}

.btn-group {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin: 16px 0;
}

/* Cards */
.card {
  background: var(--light-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  margin-bottom: 24px;
  transition: var(--trans);
}

[data-theme="dark"] .card {
  background: var(--dark-card);
}

.card h2 {
  margin: 0 0 16px;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary);
}

/* Results */
.results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin: 16px 0;
}

.stat-card {
  background: var(--light-card);
  border-radius: var(--radius);
  padding: 20px;
  text-align: center;
  box-shadow: var(--shadow);
  transition: var(--trans);
}

[data-theme="dark"] .stat-card {
  background: var(--dark-card);
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary);
  display: block;
}

.stat-label {
  color: #718096;
  font-size: 0.9rem;
  margin-top: 4px;
}

/* Simulation Area */
.sim-container {
  background: var(--light-card);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 24px;
  transition: var(--trans);
}

[data-theme="dark"] .sim-container {
  background: var(--dark-card);
}

.sim-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.view-btn {
  padding: 8px 16px;
  border: 1px solid var(--border);
  background: var(--light-card);
  border-radius: var(--radius);
  cursor: pointer;
  transition: var(--trans);
  font-size: 0.9rem;
}

.view-btn:hover {
  border-color: var(--primary);
}

.view-btn.active {
  background: var(--primary);
  color: white;
  border-color: var(--primary);
}

[data-theme="dark"] .view-btn {
  background: var(--dark-card);
  color: #cbd5e0;
  border-color: #4a5568;
}

.sim-viewport {
  width: 100%;
  min-height: 400px;
  border-radius: var(--radius);
  background: linear-gradient(45deg, #f7fafc 25%, transparent 25%),
              linear-gradient(-45deg, #f7fafc 25%, transparent 25%);
  background-size: 20px 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

[data-theme="dark"] .sim-viewport {
  background: linear-gradient(45deg, #2d3748 25%, transparent 25%),
              linear-gradient(-45deg, #2d3748 25%, transparent 25%);
}

/* SVG Styles */
.dimline {
  stroke: var(--dimline);
  stroke-width: 1.5;
  marker-end: url(#arrowend);
}

.dimlabel {
  fill: var(--dimline);
  font-size: 12px;
  font-weight: 600;
  text-anchor: middle;
}

/* Alerts */
.alert {
  padding: 16px;
  border-radius: var(--radius);
  margin: 16px 0;
  border-left: 4px solid;
}

.alert-warning {
  background: #fef5e7;
  color: #d69e2e;
  border-left-color: #d69e2e;
}

.alert-success {
  background: #f0fff4;
  color: #38a169;
  border-left-color: #38a169;
}

[data-theme="dark"] .alert-warning {
  background: rgba(214, 158, 46, 0.1);
  color: #faf089;
}

[data-theme="dark"] .alert-success {
  background: rgba(56, 161, 105, 0.1);
  color: #9ae6b4;
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar { padding: 16px; }
  .main { padding: 16px; }
  .dropdown-options { grid-template-columns: repeat(2, 1fr); }
  .results-grid { grid-template-columns: 1fr; }
  .sim-controls { justify-content: flex-start; }
  .btn-group { justify-content: center; }
}

/* Footer */
.footer {
  text-align: center;
  padding: 24px;
  color: #718096;
  font-size: 0.9rem;
  border-top: 1px solid var(--border);
  margin-top: 2rem;
}

/* Loading Animation */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
  </style>
</head>
<body data-theme="light">

<div class="container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="header">
      <h1>📦 Box Simulator</h1>
      <button class="theme-toggle" id="themeBtn">🌙</button>
    </div>

    <form id="calculatorForm">
      <!-- Model & Part Names -->
      <div class="form-group">
        <label>Model Name (ไม่บังคับ)</label>
        <input type="text" class="form-control" id="modelName" placeholder="เช่น C857">
      </div>

      <div class="form-group">
        <label>Part Name (ไม่บังคับ)</label>
        <input type="text" class="form-control" id="partName" placeholder="เช่น FR DOOR BUTTON PANEL BODY,RH">
      </div>

      <!-- Pallet Selection -->
      <div class="form-group">
        <label>เลือกขนาดพาเลท</label>
        <div class="dropdown-options" id="palletOptions">
          <div class="dropdown-option" data-value="us">
            <div class="icon">🇺🇸</div>
            <div class="label">US Standard</div>
            <div class="size">1000×1200mm</div>
          </div>
          <div class="dropdown-option active" data-value="eu">
            <div class="icon">🇪🇺</div>
            <div class="label">EU Standard</div>
            <div class="size">800×1200mm</div>
          </div>
          <div class="dropdown-option" data-value="jp">
            <div class="icon">🇯🇵</div>
            <div class="label">JP Standard</div>
            <div class="size">1100×1100mm</div>
          </div>
          <div class="dropdown-option" data-value="custom">
            <div class="icon">⚙️</div>
            <div class="label">Custom</div>
            <div class="size">กำหนดเอง</div>
          </div>
        </div>
        
        <div class="input-row" id="customPalletRow" style="display:none;">
          <input type="number" class="form-control" id="palletWidth" placeholder="Width" min="100" max="2000">
          <span>×</span>
          <input type="number" class="form-control" id="palletLength" placeholder="Length" min="100" max="2000">
          <span class="unit">mm</span>
        </div>

        <div class="input-row">
          <label style="margin:0;">ความสูงฐาน:</label>
          <input type="number" class="form-control" id="palletHeight" value="144" min="50" max="400" style="width:80px;">
          <span class="unit">mm</span>
          <label style="margin:0;">น้ำหนักพาเลท:</label>
          <input type="number" class="form-control" id="palletWeight" value="20" min="1" max="100" step="0.1" style="width:80px;">
          <span class="unit">kg</span>
        </div>
      </div>

      <!-- Box Dimensions -->
      <div class="form-group">
        <label>ขนาดกล่อง</label>
        <div class="input-row">
          <input type="number" class="form-control" id="boxWidth" value="200" min="10" max="1500" placeholder="กว้าง">
          <span>×</span>
          <input type="number" class="form-control" id="boxLength" value="300" min="10" max="1500" placeholder="ยาว">
          <span>×</span>
          <input type="number" class="form-control" id="boxHeight" value="200" min="10" max="1500" placeholder="สูง">
          <span class="unit">mm</span>
        </div>
        
        <div class="input-row">
          <label style="margin:0;">น้ำหนัก/กล่อง:</label>
          <input type="number" class="form-control" id="boxWeight" value="2" min="0" max="200" step="0.1" style="width:80px;">
          <span class="unit">kg</span>
        </div>

        <!-- Box Preview -->
        <div class="box-preview" id="boxPreview">
          <div class="box-3d" id="box3d"></div>
        </div>

        <!-- Box Color -->
        <div class="input-row">
          <label style="margin:0;">สีกล่อง:</label>
          <input type="color" id="boxColor" value="#f59f00" style="width:50px;">
          <div class="checkbox-group">
            <input type="checkbox" id="kraftBox">
            <label for="kraftBox">สีกระดาษคราฟท์</label>
          </div>
        </div>

        <!-- Color Presets -->
        <div class="form-group">
          <label>ชุดสีสำเร็จรูป</label>
          <select class="form-control" id="colorPreset">
            <option value="slate">Slate Blue</option>
            <option value="teal">Teal Gray</option>
            <option value="amber" selected>Amber Charcoal</option>
            <option value="indigo">Indigo Silver</option>
            <option value="forest">Forest Sand</option>
            <option value="crimson">Crimson Steel</option>
            <option value="royal">Royal Purple</option>
            <option value="cyan">Cyan Graphite</option>
          </select>
        </div>
      </div>

      <!-- Stacking Options -->
      <div class="form-group">
        <label>เงื่อนไขการซ้อนกล่อง</label>
        <div class="radio-group">
          <input type="radio" name="stackType" id="maxHeightMode" value="height" checked>
          <label for="maxHeightMode">ความสูงสูงสุด</label>
          <input type="number" class="form-control" id="maxHeight" value="1400" min="200" max="3000" style="width:100px;">
          <span class="unit">mm</span>
        </div>
        
        <div class="radio-group">
          <input type="radio" name="stackType" id="layerMode" value="layers">
          <label for="layerMode">จำนวนชั้น</label>
          <input type="number" class="form-control" id="boxLayers" value="3" min="1" max="20" style="width:80px;">
          <span class="unit">ชั้น</span>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="allowBoxRotate" checked>
          <label for="allowBoxRotate">อนุญาตให้หมุนกล่อง 90°</label>
        </div>
      </div>

      <!-- Truck Selection -->
      <div class="form-group">
        <label>เลือกขนาดรถบรรทุก</label>
        <div class="dropdown-options" id="truckOptions">
          <div class="dropdown-option" data-value="small">
            <div class="icon">🚐</div>
            <div class="label">รถเล็ก</div>
            <div class="size">2.3×5.3×2.3m</div>
          </div>
          <div class="dropdown-option active" data-value="medium">
            <div class="icon">🚚</div>
            <div class="label">รถกลาง</div>
            <div class="size">2.3×6.3×2.3m</div>
          </div>
          <div class="dropdown-option" data-value="large">
            <div class="icon">🚛</div>
            <div class="label">รถใหญ่</div>
            <div class="size">2.3×7.2×2.3m</div>
          </div>
          <div class="dropdown-option" data-value="custom">
            <div class="icon">⚙️</div>
            <div class="label">Custom</div>
            <div class="size">กำหนดเอง</div>
          </div>
        </div>

        <div class="input-row" id="customTruckRow" style="display:none;">
          <input type="number" class="form-control" id="truckWidth" placeholder="กว้าง" min="1500" max="3500">
          <span>×</span>
          <input type="number" class="form-control" id="truckLength" placeholder="ยาว" min="3000" max="15000">
          <span>×</span>
          <input type="number" class="form-control" id="truckHeight" placeholder="สูง" min="1500" max="4000">
          <span class="unit">mm</span>
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="allowPalletStack" checked>
          <label for="allowPalletStack">อนุญาตให้ซ้อนพาเลท</label>
        </div>

        <div class="input-row">
          <label style="margin:0;">จำนวนชั้นพาเลทสูงสุด:</label>
          <input type="number" class="form-control" id="maxPalletLayers" value="2" min="1" max="5" style="width:80px;">
        </div>

        <div class="checkbox-group">
          <input type="checkbox" id="allowPalletRotate" checked>
          <label for="allowPalletRotate">อนุญาตให้หมุนพาเลท 90°</label>
        </div>
      </div>

      <!-- Display Units -->
      <div class="form-group">
        <label>หน่วยที่แสดง</label>
        <div class="radio-group">
          <input type="radio" name="displayUnit" id="unitMM" value="mm" checked>
          <label for="unitMM">มิลลิเมตร (mm)</label>
          <input type="radio" name="displayUnit" id="unitCM" value="cm">
          <label for="unitCM">เซนติเมตร (cm)</label>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="btn-group">
        <button type="button" class="btn btn-primary" id="calculateBtn">
          🧮 คำนวณและแสดงผล
        </button>
        <button type="button" class="btn btn-outline" id="resetBtn">
          🔄 รีเซ็ต
        </button>
      </div>

    </form>
  </aside>

  <!-- Main Content -->
  <main class="main">
    
    <!-- Results Section -->
    <div id="resultsSection" style="display:none;">
      <div class="card">
        <h2>📊 ผลลัพธ์การคำนวณ</h2>
        <div id="modelPartInfo"></div>
        
        <div class="results-grid">
          <div class="stat-card">
            <span class="stat-value" id="boxesPerLayer">-</span>
            <div class="stat-label">กล่อง/ชั้น</div>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="totalLayers">-</span>
            <div class="stat-label">จำนวนชั้น</div>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="boxesPerPallet">-</span>
            <div class="stat-label">กล่อง/พาเลท</div>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="palletTotalWeight">-</span>
            <div class="stat-label">น้ำหนักพาเลท (kg)</div>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="palletsPerTruck">-</span>
            <div class="stat-label">พาเลท/รถ</div>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="totalTruckWeight">-</span>
            <div class="stat-label">น้ำหนักรวม (kg)</div>
          </div>
        </div>

        <div id="additionalInfo" class="alert alert-success" style="display:none;"></div>
      </div>
    </div>

    <!-- Simulation Section -->
    <div class="sim-container">
      <h2>🎯 Simulation 3D</h2>
      
      <div class="sim-controls">
        <div class="view-btn active" data-view="top">📋 Top View</div>
        <div class="view-btn" data-view="front">📏 Front View</div>
        <div class="view-btn" data-view="side">📐 Side View</div>
        <div class="view-btn" data-view="iso">🎲 Isometric</div>
        
        <label style="margin-left:20px;">🔍 Zoom:</label>
        <input type="range" id="zoomSlider" min="0.5" max="2.5" step="0.1" value="1" style="width:100px;">
        
        <button class="btn btn-outline" id="exportSVG">📁 Export SVG</button>
        <button class="btn btn-secondary" id="exportJSON">💾 Export JSON</button>
      </div>

      <div class="sim-viewport">
        <svg id="simulationSVG" width="800" height="500" style="max-width:100%; height:auto;">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#2095ff" />
            </marker>
          </defs>
          <text x="400" y="250" text-anchor="middle" fill="#718096" font-size="18">
            กดปุ่ม "คำนวณและแสดงผล" เพื่อดู Simulation
          </text>
        </svg>
      </div>

      <div id="simInfo" style="text-align:center; margin-top:16px; color:#718096;"></div>
    </div>

  </main>
</div>

<div class="footer">
  Copyright© 2025 Bunnamchai.bu - Thai Cubic Technology Co., Ltd
</div>

<script>
// ========== CONSTANTS ==========
const PALLET_PRESETS = {
  us: { width: 1000, length: 1200, name: "US Standard" },
  eu: { width: 800, length: 1200, name: "EU Standard" },
  jp: { width: 1100, length: 1100, name: "JP Standard" }
};

const TRUCK_PRESETS = {
  small: { width: 2300, length: 5300, height: 2300, name: "รถเล็ก" },
  medium: { width: 2300, length: 6300, height: 2300, name: "รถกลาง" },
  large: { width: 2300, length: 7200, height: 2300, name: "รถใหญ่" }
};

const COLOR_PRESETS = {
  slate: { box: "#4C6EF5", pallet: "#CED4DA", truck: "#ADB5BD", stroke: "#2B2D42" },
  teal: { box: "#0CA678", pallet: "#DEE2E6", truck: "#868E96", stroke: "#343A40" },
  amber: { box: "#F59F00", pallet: "#E9ECEF", truck: "#495057", stroke: "#212529" },
  indigo: { box: "#5C7CFA", pallet: "#E5E7EB", truck: "#9CA3AF", stroke: "#111827" },
  forest: { box: "#2B8A3E", pallet: "#EAD7BD", truck: "#A68A64", stroke: "#2D2A26" },
  crimson: { box: "#E03131", pallet: "#DDE2E5", truck: "#6C757D", stroke: "#1F2328" },
  royal: { box: "#7950F2", pallet: "#F1F3F5", truck: "#868E96", stroke: "#1B1F24" },
  cyan: { box: "#15AABF", pallet: "#DDE2E5", truck: "#5C677D", stroke: "#2E3440" }
};

// ========== GLOBAL VARIABLES ==========
let currentView = 'top';
let calculationResults = null;

// ========== UTILITY FUNCTIONS ==========
function formatNumber(num, decimals = 0) {
  return Number(num).toLocaleString('th-TH', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  });
}

function formatUnit(value, unit) {
  if (unit === 'cm') {
    return formatNumber(value / 10, 1) + ' cm';
  }
  return formatNumber(value) + ' mm';
}

function clamp(value, min, max) {
  return Math.max(min, Math.min(max, value));
}

// ========== DOM ELEMENTS ==========
const elements = {
  themeBtn: document.getElementById('themeBtn'),
  calculateBtn: document.getElementById('calculateBtn'),
  resetBtn: document.getElementById('resetBtn'),
  palletOptions: document.getElementById('palletOptions'),
  truckOptions: document.getElementById('truckOptions'),
  customPalletRow: document.getElementById('customPalletRow'),
  customTruckRow: document.getElementById('customTruckRow'),
  resultsSection: document.getElementById('resultsSection'),
  simulationSVG: document.getElementById('simulationSVG'),
  zoomSlider: document.getElementById('zoomSlider'),
  exportSVG: document.getElementById('exportSVG'),
  exportJSON: document.getElementById('exportJSON')
};

// ========== EVENT LISTENERS ==========

// Theme Toggle
elements.themeBtn.addEventListener('click', () => {
  const currentTheme = document.body.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.body.setAttribute('data-theme', newTheme);
  elements.themeBtn.textContent = newTheme === 'dark' ? '☀️' : '🌙';
  if (calculationResults) updateSimulation();
});

// Pallet Selection
elements.palletOptions.addEventListener('click', (e) => {
  const option = e.target.closest('.dropdown-option');
  if (!option) return;

  // Update active state
  elements.palletOptions.querySelectorAll('.dropdown-option').forEach(opt => 
    opt.classList.remove('active'));
  option.classList.add('active');

  const value = option.getAttribute('data-value');
  if (value === 'custom') {
    elements.customPalletRow.style.display = 'flex';
  } else {
    elements.customPalletRow.style.display = 'none';
    const preset = PALLET_PRESETS[value];
    if (preset) {
      document.getElementById('palletWidth').value = preset.width;
      document.getElementById('palletLength').value = preset.length;
    }
  }
  updateBoxPreview();
});

// Truck Selection
elements.truckOptions.addEventListener('click', (e) => {
  const option = e.target.closest('.dropdown-option');
  if (!option) return;

  // Update active state
  elements.truckOptions.querySelectorAll('.dropdown-option').forEach(opt => 
    opt.classList.remove('active'));
  option.classList.add('active');

  const value = option.getAttribute('data-value');
  if (value === 'custom') {
    elements.customTruckRow.style.display = 'flex';
  } else {
    elements.customTruckRow.style.display = 'none';
    const preset = TRUCK_PRESETS[value];
    if (preset) {
      document.getElementById('truckWidth').value = preset.width;
      document.getElementById('truckLength').value = preset.length;
      document.getElementById('truckHeight').value = preset.height;
    }
  }
});

// View Buttons
document.querySelectorAll('.view-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentView = btn.getAttribute('data-view');
    if (calculationResults) updateSimulation();
  });
});

// Box dimension inputs - update preview in real-time
['boxWidth', 'boxLength', 'boxHeight', 'boxColor'].forEach(id => {
  document.getElementById(id).addEventListener('input', updateBoxPreview);
});

// Color preset change
document.getElementById('colorPreset').addEventListener('change', (e) => {
  const preset = COLOR_PRESETS[e.target.value];
  document.getElementById('boxColor').value = preset.box;
  updateBoxPreview();
});

// Kraft checkbox
document.getElementById('kraftBox').addEventListener('change', updateBoxPreview);

// Zoom slider
elements.zoomSlider.addEventListener('input', () => {
  if (calculationResults) updateSimulation();
});

// Calculate button
elements.calculateBtn.addEventListener('click', calculate);

// Reset button
elements.resetBtn.addEventListener('click', resetForm);

// Export buttons
elements.exportSVG.addEventListener('click', exportSVG);
elements.exportJSON.addEventListener('click', exportJSON);

// ========== BOX PREVIEW FUNCTION ==========
function updateBoxPreview() {
  const width = parseInt(document.getElementById('boxWidth').value) || 200;
  const length = parseInt(document.getElementById('boxLength').value) || 300;
  const height = parseInt(document.getElementById('boxHeight').value) || 200;
  const color = document.getElementById('kraftBox').checked ? '#b08e62' : document.getElementById('boxColor').value;
  
  const maxDim = Math.max(width, length, height);
  const scale = 80 / maxDim;
  
  const w = width * scale;
  const l = length * scale;
  const h = height * scale;
  
  const box3d = document.getElementById('box3d');
  box3d.innerHTML = `
    <svg width="120" height="100" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
      <!-- Isometric box -->
      <polygon points="20,${80-h} ${20+w*0.7},${60-h} ${20+w*0.7+l*0.3},${60-h-l*0.3} ${20+l*0.3},${80-h-l*0.3}" 
               fill="${color}" stroke="#333" stroke-width="1.5" opacity="0.9"/>
      <polygon points="${20+w*0.7},${60-h} ${20+w*0.7},60 ${20+w*0.7+l*0.3},${60-l*0.3} ${20+w*0.7+l*0.3},${60-h-l*0.3}" 
               fill="${color}" stroke="#333" stroke-width="1.5" opacity="0.7"/>
      <polygon points="20,${80-h} ${20+w*0.7},${60-h} ${20+w*0.7},60 20,80" 
               fill="${color}" stroke="#333" stroke-width="1.5" opacity="0.8"/>
      <text x="60" y="95" text-anchor="middle" font-size="10" fill="#666">
        ${width}×${length}×${height} mm
      </text>
    </svg>
  `;
}

// ========== CALCULATION FUNCTIONS ==========
function getFormData() {
  // Get active pallet type
  const activePallet = elements.palletOptions.querySelector('.dropdown-option.active');
  const palletType = activePallet.getAttribute('data-value');
  
  let palletWidth, palletLength;
  if (palletType === 'custom') {
    palletWidth = parseInt(document.getElementById('palletWidth').value) || 800;
    palletLength = parseInt(document.getElementById('palletLength').value) || 1200;
  } else {
    const preset = PALLET_PRESETS[palletType];
    palletWidth = preset.width;
    palletLength = preset.length;
  }

  // Get active truck type
  const activeTruck = elements.truckOptions.querySelector('.dropdown-option.active');
  const truckType = activeTruck.getAttribute('data-value');
  
  let truckWidth, truckLength, truckHeight;
  if (truckType === 'custom') {
    truckWidth = parseInt(document.getElementById('truckWidth').value) || 2300;
    truckLength = parseInt(document.getElementById('truckLength').value) || 6300;
    truckHeight = parseInt(document.getElementById('truckHeight').value) || 2300;
  } else {
    const preset = TRUCK_PRESETS[truckType];
    truckWidth = preset.width;
    truckLength = preset.length;
    truckHeight = preset.height;
  }

  return {
    // Model info
    modelName: document.getElementById('modelName').value.trim(),
    partName: document.getElementById('partName').value.trim(),
    
    // Pallet
    pallet: {
      width: palletWidth,
      length: palletLength,
      height: parseInt(document.getElementById('palletHeight').value) || 144,
      weight: parseFloat(document.getElementById('palletWeight').value) || 20,
      type: palletType
    },
    
    // Box
    box: {
      width: parseInt(document.getElementById('boxWidth').value) || 200,
      length: parseInt(document.getElementById('boxLength').value) || 300,
      height: parseInt(document.getElementById('boxHeight').value) || 200,
      weight: parseFloat(document.getElementById('boxWeight').value) || 2,
      color: document.getElementById('kraftBox').checked ? '#b08e62' : document.getElementById('boxColor').value
    },
    
    // Stacking
    stacking: {
      type: document.querySelector('input[name="stackType"]:checked').value,
      maxHeight: parseInt(document.getElementById('maxHeight').value) || 1400,
      layers: parseInt(document.getElementById('boxLayers').value) || 3,
      allowBoxRotate: document.getElementById('allowBoxRotate').checked
    },
    
    // Truck
    truck: {
      width: truckWidth,
      length: truckLength,
      height: truckHeight,
      type: truckType,
      allowPalletStack: document.getElementById('allowPalletStack').checked,
      maxPalletLayers: parseInt(document.getElementById('maxPalletLayers').value) || 2,
      allowPalletRotate: document.getElementById('allowPalletRotate').checked
    },
    
    // Display
    displayUnit: document.querySelector('input[name="displayUnit"]:checked').value,
    colorPreset: document.getElementById('colorPreset').value
  };
}

function validateInputs(data) {
  const errors = [];
  
  if (data.box.width <= 0 || data.box.length <= 0 || data.box.height <= 0) {
    errors.push('กรุณากรอกขนาดกล่องให้ถูกต้อง');
  }
  
  if (data.pallet.width <= 0 || data.pallet.length <= 0) {
    errors.push('กรุณากรอกขนาดพาเลทให้ถูกต้อง');
  }
  
  if (data.truck.width <= 0 || data.truck.length <= 0 || data.truck.height <= 0) {
    errors.push('กรุณากรอกขนาดรถบรรทุกให้ถูกต้อง');
  }
  
  // Check if box fits on pallet
  const boxFitsNormal = (data.box.width <= data.pallet.width && data.box.length <= data.pallet.length);
  const boxFitsRotated = (data.box.length <= data.pallet.width && data.box.width <= data.pallet.length);
  
  if (!boxFitsNormal && !boxFitsRotated) {
    errors.push('กล่องใหญ่กว่าพาเลทในทุกทิศทาง');
  }
  
  if (data.stacking.type === 'height') {
    const minHeight = data.pallet.height + data.box.height;
    if (data.stacking.maxHeight < minHeight) {
      errors.push(`ความสูงสูงสุดต้องมากกว่า ${minHeight} mm`);
    }
  }
  
  return errors;
}

function calculateBoxesPerLayer(data) {
  const { box, pallet } = data;
  
  // Normal orientation
  const normalW = Math.floor(pallet.width / box.width);
  const normalL = Math.floor(pallet.length / box.length);
  const normalCount = normalW * normalL;
  
  // Rotated orientation (90 degrees)
  const rotatedW = Math.floor(pallet.width / box.length);
  const rotatedL = Math.floor(pallet.length / box.width);
  const rotatedCount = rotatedW * rotatedL;
  
  // Choose the better orientation
  let bestCount, bestOrientation, boxesW, boxesL;
  
  if (data.stacking.allowBoxRotate && rotatedCount > normalCount) {
    bestCount = rotatedCount;
    bestOrientation = 'หมุน 90°';
    boxesW = rotatedW;
    boxesL = rotatedL;
  } else {
    bestCount = normalCount;
    bestOrientation = 'ปกติ';
    boxesW = normalW;
    boxesL = normalL;
  }
  
  return {
    count: bestCount,
    orientation: bestOrientation,
    layout: { width: boxesW, length: boxesL }
  };
}

function calculateLayers(data, boxesPerLayer) {
  if (data.stacking.type === 'height') {
    const availableHeight = data.stacking.maxHeight - data.pallet.height;
    return Math.max(0, Math.floor(availableHeight / data.box.height));
  } else {
    return data.stacking.layers;
  }
}

function calculatePalletsOnTruck(data, palletTotalHeight) {
  const { truck, pallet } = data;
  
  // Pallets per layer on truck floor
  const normalW = Math.floor(truck.width / pallet.width);
  const normalL = Math.floor(truck.length / pallet.length);
  const normalCount = normalW * normalL;
  
  const rotatedW = Math.floor(truck.width / pallet.length);
  const rotatedL = Math.floor(truck.length / pallet.width);
  const rotatedCount = rotatedW * rotatedL;
  
  let palletsPerLayer, palletOrientation;
  if (data.truck.allowPalletRotate && rotatedCount > normalCount) {
    palletsPerLayer = rotatedCount;
    palletOrientation = 'หมุน 90°';
  } else {
    palletsPerLayer = normalCount;
    palletOrientation = 'ปกติ';
  }
  
  // Calculate vertical stacking
  let maxVerticalLayers = 1;
  if (data.truck.allowPalletStack) {
    maxVerticalLayers = Math.min(
      data.truck.maxPalletLayers,
      Math.floor(truck.height / palletTotalHeight)
    );
  }
  
  return {
    palletsPerLayer,
    maxVerticalLayers,
    totalPallets: palletsPerLayer * maxVerticalLayers,
    palletOrientation
  };
}

function calculate() {
  const data = getFormData();
  
  // Validate inputs
  const errors = validateInputs(data);
  if (errors.length > 0) {
    showErrors(errors);
    return;
  }
  
  // Calculate boxes per layer
  const layerResult = calculateBoxesPerLayer(data);
  
  // Calculate number of layers
  const numLayers = calculateLayers(data, layerResult.count);
  
  // Calculate totals for pallet
  const boxesPerPallet = layerResult.count * numLayers;
  const palletTotalWeight = data.pallet.weight + (boxesPerPallet * data.box.weight);
  const palletTotalHeight = data.pallet.height + (numLayers * data.box.height);
  
  // Calculate truck loading
  const truckResult = calculatePalletsOnTruck(data, palletTotalHeight);
  
  // Calculate final totals
  const totalBoxes = boxesPerPallet * truckResult.totalPallets;
  const totalWeight = palletTotalWeight * truckResult.totalPallets;
  const remainingHeight = data.truck.height - (truckResult.maxVerticalLayers * palletTotalHeight);
  
  // Store results globally
  calculationResults = {
    data,
    pallet: {
      boxesPerLayer: layerResult.count,
      boxOrientation: layerResult.orientation,
      boxLayout: layerResult.layout,
      numLayers,
      boxesPerPallet,
      totalWeight: palletTotalWeight,
      totalHeight: palletTotalHeight
    },
    truck: {
      palletsPerLayer: truckResult.palletsPerLayer,
      maxVerticalLayers: truckResult.maxVerticalLayers,
      totalPallets: truckResult.totalPallets,
      palletOrientation: truckResult.palletOrientation,
      totalWeight,
      totalBoxes,
      remainingHeight
    }
  };
  
  // Update displays
  updateResults();
  updateSimulation();
}

// ========== DISPLAY FUNCTIONS ==========
function showErrors(errors) {
  const errorHTML = errors.map(error => 
    `<div class="alert alert-warning">${error}</div>`
  ).join('');
  
  elements.resultsSection.innerHTML = errorHTML;
  elements.resultsSection.style.display = 'block';
}

function updateResults() {
  const { data, pallet, truck } = calculationResults;
  
  // Update stat cards
  document.getElementById('boxesPerLayer').textContent = formatNumber(pallet.boxesPerLayer);
  document.getElementById('totalLayers').textContent = formatNumber(pallet.numLayers);
  document.getElementById('boxesPerPallet').textContent = formatNumber(pallet.boxesPerPallet);
  document.getElementById('palletTotalWeight').textContent = formatNumber(pallet.totalWeight, 1);
  document.getElementById('palletsPerTruck').textContent = formatNumber(truck.totalPallets);
  document.getElementById('totalTruckWeight').textContent = formatNumber(truck.totalWeight, 1);
  
  // Model/Part info
  let modelPartHTML = '';
  if (data.modelName || data.partName) {
    modelPartHTML = '<div style="margin-bottom: 16px;">';
    if (data.modelName) modelPartHTML += `<strong>Model:</strong> ${data.modelName} `;
    if (data.partName) modelPartHTML += `<strong>Part:</strong> ${data.partName}`;
    modelPartHTML += '</div>';
  }
  document.getElementById('modelPartInfo').innerHTML = modelPartHTML;
  
  // Additional info
  const additionalInfo = document.getElementById('additionalInfo');
  additionalInfo.innerHTML = `
    <strong>สรุป:</strong> กล่องต่อชั้น ${pallet.boxesPerLayer} ใบ (${pallet.boxOrientation}) × 
    ${pallet.numLayers} ชั้น = ${pallet.boxesPerPallet} กล่อง/พาเลท<br>
    <strong>รถบรรทุก:</strong> ${truck.palletsPerLayer} พาเลท/ชั้น (${truck.palletOrientation}) × 
    ${truck.maxVerticalLayers} ชั้น = ${truck.totalPallets} พาเลท รวม ${truck.totalBoxes} กล่อง<br>
    <strong>พื้นที่เหลือ:</strong> ความสูง ${formatUnit(truck.remainingHeight, data.displayUnit)}
  `;
  additionalInfo.style.display = 'block';
  
  elements.resultsSection.style.display = 'block';
}

function updateSimulation() {
  const { data, pallet, truck } = calculationResults;
  const preset = COLOR_PRESETS[data.colorPreset];
  const zoom = parseFloat(elements.zoomSlider.value);
  
  const svg = elements.simulationSVG;
  svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#2095ff" /></marker></defs>';
  
  const svgWidth = 800;
  const svgHeight = 500;
  const margin = 60;
  
  let content = '';
  let infoText = '';
  
  if (currentView === 'top') {
    // Top view: Pallet with boxes layout (นี่ทำงานถูกต้องแล้ว)
    const scale = Math.min((svgWidth - margin * 2) / data.pallet.width, (svgHeight - margin * 2) / data.pallet.length) * zoom * 0.8;
    const palletW = data.pallet.width * scale;
    const palletL = data.pallet.length * scale;
    const startX = (svgWidth - palletW) / 2;
    const startY = (svgHeight - palletL) / 2;
    
    // Draw pallet base
    content += `<rect x="${startX}" y="${startY}" width="${palletW}" height="${palletL}" 
                fill="${preset.pallet}" stroke="${preset.stroke}" stroke-width="3"/>`;
    
    // Calculate actual box dimensions based on orientation
    let actualBoxW = data.box.width;
    let actualBoxL = data.box.length;
    
    if (pallet.boxOrientation === 'หมุน 90°') {
      actualBoxW = data.box.length;
      actualBoxL = data.box.width;
    }
    
    const boxScaleW = actualBoxW * scale;
    const boxScaleL = actualBoxL * scale;
    
    // Draw boxes
    for (let i = 0; i < pallet.boxLayout.width; i++) {
      for (let j = 0; j < pallet.boxLayout.length; j++) {
        const x = startX + (i * boxScaleW);
        const y = startY + (j * boxScaleL);
        content += `<rect x="${x + 2}" y="${y + 2}" width="${boxScaleW - 4}" height="${boxScaleL - 4}" 
                    fill="${data.box.color}" stroke="${preset.stroke}" stroke-width="1" opacity="0.8"/>`;
      }
    }
    
    // Dimension lines
    content += `<line x1="${startX}" y1="${startY + palletL + 30}" x2="${startX + palletW}" y2="${startY + palletL + 30}" 
                stroke="#2095ff" stroke-width="2" marker-start="url(#arrowhead)" marker-end="url(#arrowhead)"/>`;
    content += `<text x="${startX + palletW/2}" y="${startY + palletL + 50}" text-anchor="middle" fill="#2095ff" font-weight="bold" font-size="14">
                ${formatUnit(data.pallet.width, data.displayUnit)}</text>`;
    
    infoText = `Top View - ${pallet.boxesPerLayer} กล่อง/ชั้น (${pallet.boxOrientation})`;
    
  } else if (currentView === 'front') {
    // Front view: แก้ไขให้ถูกต้อง
    const totalHeight = pallet.totalHeight;
    const scale = Math.min((svgWidth - margin * 2) / data.pallet.width, (svgHeight - margin * 2) / totalHeight) * zoom * 0.7;
    
    const palletW = data.pallet.width * scale;
    const palletBaseH = data.pallet.height * scale;
    const boxLayerH = data.box.height * scale;
    
    const startX = (svgWidth - palletW) / 2;
    const startY = svgHeight - margin - palletBaseH;
    
    // Draw pallet base
    content += `<rect x="${startX}" y="${startY}" width="${palletW}" height="${palletBaseH}" 
                fill="${preset.pallet}" stroke="${preset.stroke}" stroke-width="3"/>`;
    
    // Draw box layers from bottom to top
    for (let layer = 0; layer < pallet.numLayers; layer++) {
      const layerY = startY - ((layer + 1) * boxLayerH);
      content += `<rect x="${startX}" y="${layerY}" width="${palletW}" height="${boxLayerH}" 
                  fill="${data.box.color}" stroke="${preset.stroke}" stroke-width="1.5" opacity="0.8"/>`;
      
      // Add layer divider lines
      content += `<line x1="${startX + 5}" y1="${layerY + boxLayerH}" x2="${startX + palletW - 5}" y2="${layerY + boxLayerH}" 
                  stroke="${preset.stroke}" stroke-width="0.8" opacity="0.4" stroke-dasharray="3,2"/>`;
    }
    
    // Height dimension line
    const topY = startY - (pallet.numLayers * boxLayerH);
    content += `<line x1="${startX + palletW + 15}" y1="${startY + palletBaseH}" x2="${startX + palletW + 15}" y2="${topY}" 
                stroke="#2095ff" stroke-width="2" marker-start="url(#arrowhead)" marker-end="url(#arrowhead)"/>`;
    content += `<text x="${startX + palletW + 35}" y="${(startY + palletBaseH + topY) / 2}" text-anchor="middle" fill="#2095ff" font-weight="bold" font-size="12" transform="rotate(-90 ${startX + palletW + 35} ${(startY + palletBaseH + topY) / 2})">
                ${formatUnit(totalHeight, data.displayUnit)}</text>`;
    
    infoText = `Front View - ${pallet.numLayers} ชั้น × ${pallet.boxesPerLayer} กล่อง = ${pallet.boxesPerPallet} กล่อง/พาเลท`;
    
  } else if (currentView === 'side') {
    // Side view: แก้ไขให้ถูกต้อง
    const totalHeight = pallet.totalHeight;
    const scale = Math.min((svgWidth - margin * 2) / data.pallet.length, (svgHeight - margin * 2) / totalHeight) * zoom * 0.7;
    
    const palletL = data.pallet.length * scale;
    const palletBaseH = data.pallet.height * scale;
    const boxLayerH = data.box.height * scale;
    
    const startX = (svgWidth - palletL) / 2;
    const startY = svgHeight - margin - palletBaseH;
    
    // Draw pallet base
    content += `<rect x="${startX}" y="${startY}" width="${palletL}" height="${palletBaseH}" 
                fill="${preset.pallet}" stroke="${preset.stroke}" stroke-width="3"/>`;
    
    // Draw box layers
    for (let layer = 0; layer < pallet.numLayers; layer++) {
      const layerY = startY - ((layer + 1) * boxLayerH);
      content += `<rect x="${startX}" y="${layerY}" width="${palletL}" height="${boxLayerH}" 
                  fill="${data.box.color}" stroke="${preset.stroke}" stroke-width="1.5" opacity="0.8"/>`;
    }
    
    // Length dimension line
    content += `<line x1="${startX}" y1="${startY + palletBaseH + 20}" x2="${startX + palletL}" y2="${startY + palletBaseH + 20}" 
                stroke="#2095ff" stroke-width="2" marker-start="url(#arrowhead)" marker-end="url(#arrowhead)"/>`;
    content += `<text x="${startX + palletL/2}" y="${startY + palletBaseH + 40}" text-anchor="middle" fill="#2095ff" font-weight="bold" font-size="14">
                ${formatUnit(data.pallet.length, data.displayUnit)}</text>`;
    
    infoText = `Side View - ความสูงรวม ${formatUnit(pallet.totalHeight, data.displayUnit)}`;
    
  } else if (currentView === 'iso') {
    // Isometric view: แก้ไขให้ถูกต้อง
    const baseScale = 0.15 * zoom;
    const centerX = svgWidth / 2;
    const centerY = svgHeight / 2 + 30;
    
    // Isometric angles
    const cos30 = Math.cos(Math.PI / 6); // 0.866
    const sin30 = Math.sin(Math.PI / 6); // 0.5
    
    // Scale dimensions
    const palletW = data.pallet.width * baseScale;
    const palletL = data.pallet.length * baseScale;
    const palletH = data.pallet.height * baseScale;
    const boxH = data.box.height * baseScale;
    
    // Calculate isometric coordinates for pallet base
    function isoPoint(x, y, z) {
      return {
        x: centerX + (x - y) * cos30,
        y: centerY - z - (x + y) * sin30
      };
    }
    
    // Draw pallet base (3D box)
    const p1 = isoPoint(0, 0, 0);
    const p2 = isoPoint(palletW, 0, 0);
    const p3 = isoPoint(palletW, palletL, 0);
    const p4 = isoPoint(0, palletL, 0);
    const p5 = isoPoint(0, 0, palletH);
    const p6 = isoPoint(palletW, 0, palletH);
    const p7 = isoPoint(palletW, palletL, palletH);
    const p8 = isoPoint(0, palletL, palletH);
    
    // Pallet faces
    content += `<polygon points="${p5.x},${p5.y} ${p6.x},${p6.y} ${p7.x},${p7.y} ${p8.x},${p8.y}" 
                fill="${preset.pallet}" stroke="${preset.stroke}" stroke-width="2"/>`;
    content += `<polygon points="${p6.x},${p6.y} ${p2.x},${p2.y} ${p3.x},${p3.y} ${p7.x},${p7.y}" 
                fill="${preset.pallet}" opacity="0.8" stroke="${preset.stroke}" stroke-width="2"/>`;
    content += `<polygon points="${p7.x},${p7.y} ${p3.x},${p3.y} ${p4.x},${p4.y} ${p8.x},${p8.y}" 
                fill="${preset.pallet}" opacity="0.6" stroke="${preset.stroke}" stroke-width="2"/>`;
    
    // Draw box layers
    for (let layer = 0; layer < pallet.numLayers; layer++) {
      const layerZ = palletH + (layer * boxH);
      const layerTop = layerZ + boxH;
      
      const b1 = isoPoint(0, 0, layerTop);
      const b2 = isoPoint(palletW, 0, layerTop);
      const b3 = isoPoint(palletW, palletL, layerTop);
      const b4 = isoPoint(0, palletL, layerTop);
      
      // Box layer faces
      content += `<polygon points="${b1.x},${b1.y} ${b2.x},${b2.y} ${b3.x},${b3.y} ${b4.x},${b4.y}" 
                  fill="${data.box.color}" stroke="${preset.stroke}" stroke-width="1.5" opacity="0.8"/>`;
      
      if (layer === pallet.numLayers - 1) {
        // Side faces for top layer only
        const b5 = isoPoint(0, 0, layerZ);
        const b6 = isoPoint(palletW, 0, layerZ);
        const b7 = isoPoint(palletW, palletL, layerZ);
        const b8 = isoPoint(0, palletL, layerZ);
        
        content += `<polygon points="${b2.x},${b2.y} ${b6.x},${b6.y} ${b7.x},${b7.y} ${b3.x},${b3.y}" 
                    fill="${data.box.color}" opacity="0.6" stroke="${preset.stroke}" stroke-width="1"/>`;
        content += `<polygon points="${b3.x},${b3.y} ${b7.x},${b7.y} ${b8.x},${b8.y} ${b4.x},${b4.y}" 
                    fill="${data.box.color}" opacity="0.4" stroke="${preset.stroke}" stroke-width="1"/>`;
      }
    }
    
    infoText = `Isometric View - 3D มุมมองรวม ${pallet.boxesPerPallet} กล่อง`;
  }
  
  svg.innerHTML += content;
  document.getElementById('simInfo').textContent = infoText;
}


// ========== EXPORT FUNCTIONS ==========
function exportSVG() {
  if (!calculationResults) return;
  
  const svgContent = elements.simulationSVG.outerHTML;
  const blob = new Blob([svgContent], { type: 'image/svg+xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `box-simulation-${currentView}.svg`;
  a.click();
  URL.revokeObjectURL(url);
}

function exportJSON() {
  if (!calculationResults) return;
  
  const exportData = {
    timestamp: new Date().toISOString(),
    inputs: calculationResults.data,
    results: {
      pallet: calculationResults.pallet,
      truck: calculationResults.truck
    }
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'box-simulation-results.json';
  a.click();
  URL.revokeObjectURL(url);
}

// ========== RESET FUNCTION ==========
function resetForm() {
  // Reset all form fields to defaults
  document.getElementById('modelName').value = '';
  document.getElementById('partName').value = '';
  
  // Reset pallet to EU standard
  elements.palletOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('active'));
  elements.palletOptions.querySelector('[data-value="eu"]').classList.add('active');
  elements.customPalletRow.style.display = 'none';
  document.getElementById('palletHeight').value = 144;
  document.getElementById('palletWeight').value = 20;
  
  // Reset truck to medium
  elements.truckOptions.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('active'));
  elements.truckOptions.querySelector('[data-value="medium"]').classList.add('active');
  elements.customTruckRow.style.display = 'none';
  
  // Reset box dimensions
  document.getElementById('boxWidth').value = 200;
  document.getElementById('boxLength').value = 300;
  document.getElementById('boxHeight').value = 200;
  document.getElementById('boxWeight').value = 2;
  document.getElementById('boxColor').value = '#f59f00';
  document.getElementById('kraftBox').checked = false;
  document.getElementById('colorPreset').value = 'amber';
  
  // Reset stacking
  document.getElementById('maxHeightMode').checked = true;
  document.getElementById('maxHeight').value = 1400;
  document.getElementById('boxLayers').value = 3;
  document.getElementById('allowBoxRotate').checked = true;
  
  // Reset truck options
  document.getElementById('allowPalletStack').checked = false;
  document.getElementById('maxPalletLayers').value = 1;
  document.getElementById('allowPalletRotate').checked = true;
  
  // Reset display
  document.getElementById('unitMM').checked = true;
  
  // Hide results
  elements.resultsSection.style.display = 'none';
  
  // Reset simulation
  elements.simulationSVG.innerHTML = `
    <text x="400" y="250" text-anchor="middle" fill="#718096" font-size="18">
      กดปุ่ม "คำนวณและแสดงผล" เพื่อดู Simulation
    </text>
  `;
  document.getElementById('simInfo').textContent = '';
  
  calculationResults = null;
  updateBoxPreview();
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', () => {
  // Set initial values
  resetForm();
  updateBoxPreview();
});
</script>

</body>
</html>
