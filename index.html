<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pallet & Truck Box Simulator</title>
  <style>
:root {
  /* Theme & Color Variables */
  --light-bg: #f8f9fa;
  --dark-bg: #181c20;
  --light-card: #fff;
  --dark-card: #23272c;
  --border: #ced4da;
  --stroke: #212529;
  --dimline: #2095ff;
  --palette-slate: #4c6ef5;
  --trans-fast: background 0.15s, color 0.15s;
  --font-head: 700 1.2rem 'Sarabun', Arial, sans-serif;
  --font-body: 400 1rem 'Sarabun', Arial, sans-serif;
}
[data-theme="dark"] {
  --light-bg: #181c20;
  --light-card: #23272c;
  --border: #23272c;
  --stroke: #e9ecef;
}
body {
  background: var(--light-bg);
  color: #23272c;
  font: var(--font-body);
  margin: 0;
  min-height: 100vh;
  transition: var(--trans-fast);
}
[data-theme="dark"] body {
  background: var(--dark-bg);
  color: #f7f7f7;
}
.container {
  display: flex;
  align-items: flex-start;
  justify-content: flex-start;
  min-height: 100vh;
}
@media (max-width: 800px) {
  .container { flex-direction: column; }
}
.sidebar {
  width: 320px;
  min-width: 240px;
  background: var(--light-card);
  padding: 24px 14px;
  box-shadow: 0 1px 5px #22334422;
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 1.6rem;
  transition: var(--trans-fast);
}
[data-theme="dark"] .sidebar {
  background: var(--dark-card);
  border-right: 1px solid #33383e;
}
@media (max-width: 800px) {
  .sidebar {
    width: 100vw; min-width: unset;
    border-right: none;
    border-bottom: 1px solid var(--border);
    box-shadow: none;
  }
}
.main {
  flex: 1;
  min-width: 330px;
  padding: 22px 18px;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  background: var(--light-bg);
  transition: var(--trans-fast);
}
[data-theme="dark"] .main {
  background: var(--dark-bg);
}
h1 { font: var(--font-head); margin: 0 0 1rem;}
form label { font-weight: 600; margin-bottom: 6px; display:block;}
.form-group { margin-bottom: 1.2em; }
input, select {
  background: #fff;
  border: 1px solid var(--border);
  border-radius: 4px; padding:7px 8px;
  width: 100%; font-family: inherit; font-size: 1rem;
  box-sizing: border-box;
  transition: var(--trans-fast);
}
[data-theme="dark"] input, [data-theme="dark"] select {
  background: #23272c;
  color: #fff; border:1px solid #39414a;
}
input[type="checkbox"], input[type="radio"], input[type="color"] {
  width: auto !important; margin-right: 7px;
}
input[type="radio"] { vertical-align:-1.5px;}
.input-row { display: flex; align-items: center; gap:10px;}
.small { font-size: 0.94em; margin-left: 0.2em;}
button {
  border:none; border-radius:4px;
  background:#4c6ef5;color:#fff; font: var(--font-head); padding:10px 18px; margin: 5px 0; cursor:pointer;
  box-shadow:0 1px 3px #22334418; transition: all 0.13s;
}
button:hover { background:#364fc7; }
.btn-group { display:flex; gap:7px; flex-wrap:wrap;}
.card {
  background: var(--light-card);
  border-radius:8px;
  box-shadow:0 2px 7px #22334419;
  padding: 1.5rem 1rem 1rem;
  margin-bottom:1.5em;
  transition: var(--trans-fast);
}
[data-theme="dark"] .card{ background: var(--dark-card);}
.card h2 { margin-top:0;}
.warning, .successmsg {
  padding: 9px 12px; margin-bottom: 1em; border-radius: 6px;
  font-size: 1em;
}
.warning { background: #ffe1d4; color: #ad3933; border-left:4px solid #e03131;}
.successmsg { background: #e4ffe9; color: #16814d; border-left:4px solid #2ba84a;}

.sim-area {
  background: var(--light-card);
  border-radius: 10px;
  box-shadow: 0 1px 7px #22334416;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 520px;
  justify-content: flex-start;
  padding: 1rem 0.7rem;
  gap: 0.2rem;
  position:relative;
}
[data-theme="dark"] .sim-area { background: var(--dark-card); }
.sim-views {
  display: flex; flex-wrap:wrap;
  gap: 1.2em; justify-content:center;
}
.sim-svg-area {
  min-width: 240px; min-height: 300px;
  display:flex; flex:1; align-items:center; justify-content:center;
  position:relative;
  background:none;
}
.sim-controls {
  display: flex; gap: 8px; margin: 6px 0 0;
  align-items: center; flex-wrap: wrap;
}
.sim-controls button, .sim-controls label { font-size: 0.98rem; }
.sim-controls select, .sim-controls input { width:auto;}

.dimline {
  stroke: var(--dimline); stroke-width:1.4;
  marker-end: url(#arrowend);
}
.dimlabel { fill: var(--dimline); font-size: 11px; font-weight:600;}
.viewbtn.active { background:#4c6ef5 !important; color:#fff;}
@media (max-width: 700px) {
  .main{ padding: 7px 2px; }
  .card{ padding: 0.9rem 0.4rem;}
  .sim-svg-area{ min-width:unset; min-height:200px;}
}
  </style>
</head>
<body>
<div class="container">
  <aside class="sidebar" id="sidebar">
    <h1>Pallet &amp; Truck Box Simulator</h1>
    <form id="configForm" autocomplete="off">
      <!-- Model/Part -->
      <div class="form-group">
        <label>ชื่อโมเดล <span class="small">(ไม่บังคับ)</span></label>
        <input type="text" id="modelName" placeholder="Model Name">
      </div>
      <div class="form-group">
        <label>ชื่อชิ้นส่วน <span class="small">(ไม่บังคับ)</span></label>
        <input type="text" id="partName" placeholder="Part Name">
      </div>
      <!-- Pallet -->
      <div class="form-group">
        <label>ขนาดพาเลท</label>
        <div class="input-row">
          <input type="radio" name="palletStd" id="palletUS" value="us"> <label for="palletUS" class="small">US 1000x1200</label>
          <input type="radio" name="palletStd" id="palletJP" value="jp"> <label for="palletJP" class="small">JP 1100x1100</label>
          <input type="radio" name="palletStd" id="palletEU" value="eu"> <label for="palletEU" class="small">EU 800x1200</label>
          <input type="radio" name="palletStd" id="palletCustom" value="custom"> <label for="palletCustom" class="small">Custom</label>
        </div>
        <div class="input-row">
          <input type="number" id="palletWidth" min="100" max="2000" step="1" style="width:64px;" required> x
          <input type="number" id="palletLength" min="100" max="2000" step="1" style="width:64px;" required>
          <span class="unitlbl">mm</span>
        </div>
        <div class="input-row">
          <label class="small">ฐานสูง</label>
          <input type="number" id="palletBaseHeight" min="50" max="400" step="1" style="width:64px;" required>
          <span class="unitlbl">mm</span>
          <label class="small">Tare (kg)</label>
          <input type="number" id="palletTareWeight" min="1" max="100" step="0.1" style="width:64px;" required>
        </div>
      </div>
      <!-- Box Inputs -->
      <div class="form-group">
        <label>ขนาดกล่อง &amp; น้ำหนัก</label>
        <div class="input-row">
          <input type="number" id="boxWidth" min="30" max="1500" required style="width:58px;"> x
          <input type="number" id="boxLength" min="30" max="1500" required style="width:58px;"> x
          <input type="number" id="boxHeight" min="10" max="1500" required style="width:58px;">
          <span class="unitlbl">mm</span>
        </div>
        <div class="input-row">
          <label class="small">ต่อใบ</label>
          <input type="number" id="boxWeight" min="0" max="200" step="0.1" style="width:70px;" placeholder="0">
          <span class="small">kg</span>
        </div>
        <div class="input-row">
          <label class="small">สี</label>
          <input type="color" id="boxColor" value="#f59f00" title="เลือกสีกล่อง">
          <input type="checkbox" id="boxKraft"><label for="boxKraft" class="small">สีกระดาษ/คราฟท์</label>
        </div>
        <div class="form-group">
          <label>ชุดสี</label>
          <select id="colorPreset">
            <option value="slate">Slate Blue</option>
            <option value="teal">Teal Gray</option>
            <option value="amber">Amber Charcoal</option>
            <option value="indigo">Indigo Silver</option>
            <option value="forest">Forest Sand</option>
            <option value="crimson">Crimson Steel</option>
            <option value="royal">Royal Purple</option>
            <option value="cyan">Cyan Graphite</option>
          </select>
        </div>
      </div>
      <!-- Box stacking options -->
      <div class="form-group">
        <label>การวางกล่องบนพาเลท</label>
        <div class="input-row">
          <input type="radio" name="stackCond" id="stackMaxH" value="maxh" checked><label for="stackMaxH" class="small">Max Height</label>
          <input type="number" id="maxHeight" min="200" max="2500" step="1" value="1400" style="width:65px;">
          <span class="unitlbl">mm</span>
        </div>
        <div class="input-row">
          <input type="radio" name="stackCond" id="stackLayer" value="layer"><label for="stackLayer" class="small">จำนวนชั้น</label>
          <input type="number" id="boxLayers" min="1" max="30" step="1" value="1" style="width:48px;">
          <span class="small">ชั้น</span>
        </div>
        <div class="input-row">
          <input type="checkbox" id="allowBoxRotate" checked>
          <label for="allowBoxRotate" class="small">อนุญาตหมุนกล่อง 90°</label>
        </div>
      </div>
      <!-- Truck options -->
      <div class="form-group">
        <label>ขนาดรถบรรทุก</label>
        <div class="input-row">
          <input type="radio" name="truckStd" id="truckSmall" value="small"><label for="truckSmall" class="small">เล็ก</label>
          <input type="radio" name="truckStd" id="truckMed" value="med"><label for="truckMed" class="small">กลาง</label>
          <input type="radio" name="truckStd" id="truckLarge" value="large"><label for="truckLarge" class="small">ใหญ่</label>
          <input type="radio" name="truckStd" id="truckCustom" value="custom"><label for="truckCustom" class="small">Custom</label>
        </div>
        <div class="input-row">
          <input type="number" id="truckWidth" min="1000" max="3500" step="1" style="width:60px;"> x
          <input type="number" id="truckLength" min="2000" max="20000" step="1" style="width:70px;"> x
          <input type="number" id="truckHeight" min="1000" max="5000" step="1" style="width:60px;">
          <span class="unitlbl">mm</span>
        </div>
        <div class="input-row">
          <input type="checkbox" id="allowPalletStack" checked>
          <label for="allowPalletStack" class="small">วางพาเลทซ้อนกัน</label>
        </div>
        <div class="input-row">
          <label class="small">Max ขั้น</label>
          <input type="number" id="truckMaxPalletLayers" min="1" max="10" value="2" style="width: 50px;">
        </div>
        <div class="input-row">
          <input type="checkbox" id="allowPalletRotate" checked>
          <label for="allowPalletRotate" class="small">หมุนพาเลท 90° บนรถได้</label>
        </div>
      </div>
      <!-- Others -->
      <div class="form-group">
        <label>หน่วยแสดงผล</label>
        <div class="input-row">
          <input type="radio" name="unit" id="unitMM" value="mm" checked><label for="unitMM">mm</label>
          <input type="radio" name="unit" id="unitCM" value="cm"><label for="unitCM">cm</label>
        </div>
      </div>
      <!-- Buttons -->
      <div class="btn-group">
        <button type="button" id="calcBtn">Calculate &amp; Render</button>
        <button type="reset" id="resetBtn" style="background:#868e96;padding:8px 14px;">รีเซ็ตค่าเริ่มต้น</button>
      </div>
      <div class="btn-group">
        <label class="small">ธีม:</label>
        <button type="button" id="themeToggle" style="background:#fff;color:#4c6ef5;border:1px solid #4c6ef5;width:38px;background:#c5d0fa;">&#9788;</button>
      </div>
    </form>
    <!-- END form -->
  </aside>
  <main class="main">
    <div id="outputArea"></div>
    <div class="sim-area">
      <div class="sim-controls">
        <label class="small">มุมมอง:</label>
        <button class="viewbtn" data-v="top">Top</button>
        <button class="viewbtn" data-v="front">Front</button>
        <button class="viewbtn" data-v="side">Side</button>
        <button class="viewbtn" data-v="iso">Iso</button>
        <label class="small">Zoom:</label>
        <input id="zoomSlider" type="range" min="0.5" max="2.5" value="1" step="0.1" style="width:70px;">
        <button id="exportSvgBtn" title="Export SVG" style="background:#fff;color:#4c6ef5;border:1px solid #4c6ef5;"><b>SVG</b></button>
        <button id="exportJsonBtn" title="Export JSON" style="background: #20c997;">JSON</button>
      </div>
      <div class="sim-svg-area">
        <svg id="palletSvg" width="460" height="320" 
          style="background:none; max-width:98%; height:auto;display:block;">
          <defs><marker id="arrowend" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#2095ff"></polygon></marker></defs>
        </svg>
      </div>
      <div id="simLabels" style="text-align:center;"></div>
    </div>
  </main>
</div>
<script>
// --------------------- Presets
const PALET_STD = {
  us: { width:1000, length:1200 },
  jp: { width:1100, length:1100 },
  eu: { width:800, length:1200 }
};
const TRUCK_STD = {
  small: { width:2300, length:5300, height:2300 },
  med:   { width:2300, length:6300, height:2300 },
  large: { width:2300, length:7200, height:2300 }
};
const COLOR_PRESETS = {
  slate: { box:"#4C6EF5", pallet:"#CED4DA", truck:"#ADB5BD", stroke:"#2B2D42", bglt:"#F8F9FA", bgdk:"#0B0C10" },
  teal: { box:"#0CA678", pallet:"#DEE2E6", truck:"#868E96", stroke:"#343A40", bglt:"#FFF", bgdk:"#0E1116" },
  amber: { box:"#F59F00", pallet:"#E9ECEF", truck:"#495057", stroke:"#212529", bglt:"#FAFAFB", bgdk:"#111217" },
  indigo: { box:"#5C7CFA", pallet:"#E5E7EB", truck:"#9CA3AF", stroke:"#111827", bglt:"#F9FAFB", bgdk:"#0A0B0E" },
  forest: { box:"#2B8A3E", pallet:"#EAD7BD", truck:"#A68A64", stroke:"#2D2A26", bglt:"#FFFCF7", bgdk:"#14110F" },
  crimson: { box:"#E03131", pallet:"#DDE2E5", truck:"#6C757D", stroke:"#1F2328", bglt:"#FFF", bgdk:"#0D1117" },
  royal: { box:"#7950F2", pallet:"#F1F3F5", truck:"#868E96", stroke:"#1B1F24", bglt:"#F8FAFC", bgdk:"#0B0E14" },
  cyan: { box:"#15AABF", pallet:"#DDE2E5", truck:"#5C677D", stroke:"#2E3440", bglt:"#F6F7F9", bgdk:"#0F1115" }
};
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
function mm(v){ return v; }
function cm(v){ return v/10; }
function round2(x){ return Math.round(x*100)/100; }

// ---- Theme ----
function setTheme(isDark) {
  document.documentElement.setAttribute("data-theme", isDark?"dark":"light");
  document.getElementById("themeToggle").innerHTML = isDark?"&#9790;":"&#9788;";
}
document.getElementById("themeToggle").onclick = function() {
  const dark = document.documentElement.getAttribute('data-theme')!=="dark";
  setTheme(dark);
  renderAll();
};
// ---- Color Preset
function applyPreset() {
  const p = COLOR_PRESETS[document.getElementById("colorPreset").value];
  document.getElementById("boxColor").value = p.box;
}

// ---- Reset Default
function setDefaults() {
  // Pallet EU
  document.getElementById('palletEU').checked = true;
  document.getElementById("palletWidth").value = 800;
  document.getElementById("palletLength").value = 1200;
  document.getElementById("palletBaseHeight").value = 144;
  document.getElementById("palletTareWeight").value = 20;
  // Box 200x300x200 mm, 2 kg
  document.getElementById("boxWidth").value = 200;
  document.getElementById("boxLength").value = 300;
  document.getElementById("boxHeight").value = 200;
  document.getElementById("boxWeight").value = 2;
  document.getElementById("boxColor").value = "#f59f00";
  document.getElementById("boxKraft").checked = false;
  document.getElementById("colorPreset").value = "amber";
  // Stack Max Height
  document.getElementById("stackMaxH").checked = true;
  document.getElementById("maxHeight").value = 1200;
  document.getElementById("boxLayers").value = 1;
  document.getElementById("allowBoxRotate").checked = true;
  // Truck กลาง
  document.getElementById("truckMed").checked = true;
  document.getElementById("truckWidth").value = 2300;
  document.getElementById("truckLength").value = 6300;
  document.getElementById("truckHeight").value = 2300;
  document.getElementById("allowPalletStack").checked = true;
  document.getElementById("truckMaxPalletLayers").value = 2;
  document.getElementById("allowPalletRotate").checked = true;
  // Units mm
  document.getElementById("unitMM").checked = true;
  document.getElementById("modelName").value = "";
  document.getElementById("partName").value = "";
  setTimeout(applyPreset,24);
}
document.getElementById("resetBtn").onclick = setDefaults;
document.getElementById("colorPreset").onchange = function(){applyPreset(); renderAll();}
setTheme(false); setDefaults();

// ---- Form Handlers - sync Pallet/Truck selection to input ----
const palletRadios = document.querySelectorAll("input[name='palletStd']");
palletRadios.forEach(r=>{
  r.onchange = function(){
    const k = r.value; if(k in PALET_STD){
      const p = PALET_STD[k];
      document.getElementById("palletWidth").value = p.width;
      document.getElementById("palletLength").value = p.length;
    }
  }
});
const truckRadios = document.querySelectorAll("input[name='truckStd']");
truckRadios.forEach(r=>{
  r.onchange = function(){
    const k = r.value; if(k in TRUCK_STD){
      const p = TRUCK_STD[k];
      document.getElementById("truckWidth").value = p.width;
      document.getElementById("truckLength").value = p.length;
      document.getElementById("truckHeight").value = p.height;
    }
  }
});
// ---- Unit Toggle mm/cm ----
const unitRadios = document.querySelectorAll("input[name='unit']");
unitRadios.forEach(r=>r.onchange=renderAll);

// ---- Real-time validation ----
const inputs = document.querySelectorAll("input,select");
inputs.forEach(i=>i.oninput=renderAll);

// ---- Calculate & Render
document.getElementById("calcBtn").onclick = function(){ renderAll(); };
function renderAll(){
  // get form
  const F=parseInputs();
  const warn = validateInputs(F);
  if(warn.length){ setReport(warn.map(x=>`<div class="warning">${x}</div>`).join('')); clearSim(); return;}
  // computing
  const palletResults = computePallet(F);
  const truckResults = computeTruck(F, palletResults);
  setReport(renderReport(F, palletResults, truckResults));
  renderSim(F, palletResults, truckResults);
}
function clearSim(){
  document.getElementById("simLabels").innerHTML="";
  let svg = document.getElementById("palletSvg"); svg.innerHTML="";
}

// ---- Input Parsing ----
function parseInputs() {
  // Pallet
  let pw = mm(parseInt(document.getElementById('palletWidth').value)||0),
      pl = mm(parseInt(document.getElementById('palletLength').value)||0),
      pb = mm(parseInt(document.getElementById('palletBaseHeight').value)||0),
      ptw = parseFloat(document.getElementById('palletTareWeight').value)||0;
  // Box
  let bw = mm(parseInt(document.getElementById('boxWidth').value)||0),
      bl = mm(parseInt(document.getElementById('boxLength').value)||0),
      bh = mm(parseInt(document.getElementById('boxHeight').value)||0),
      bwgt = parseFloat(document.getElementById('boxWeight').value)||0;
  // Stack Cond
  let stackType = document.getElementById('stackMaxH').checked?"maxh":"layer",
      maxHeight = mm(parseInt(document.getElementById('maxHeight').value)||1400),
      boxLayers = parseInt(document.getElementById('boxLayers').value)||1,
      allowBoxRotate = document.getElementById('allowBoxRotate').checked;
  // Truck
  let tw = mm(parseInt(document.getElementById('truckWidth').value)||0),
      tl = mm(parseInt(document.getElementById('truckLength').value)||0),
      th = mm(parseInt(document.getElementById('truckHeight').value)||0),
      allowPalletStack = document.getElementById('allowPalletStack').checked,
      truckMaxPalletLayers = parseInt(document.getElementById('truckMaxPalletLayers').value)||1,
      allowPalletRotate = document.getElementById('allowPalletRotate').checked;
  // Units
  let unit = document.getElementById('unitMM').checked?"mm":"cm";
  // Color
  let boxColor = document.getElementById('boxColor').value,
      boxKraft = document.getElementById('boxKraft').checked,
      colorPreset = document.getElementById('colorPreset').value;
  // Name
  let modelName = document.getElementById("modelName").value.trim(),
      partName = document.getElementById("partName").value.trim();
  return {
    pw,pl,pb,ptw, bw,bl,bh,bwgt, stackType,maxHeight,boxLayers, allowBoxRotate,
    tw,tl,th, allowPalletStack, truckMaxPalletLayers, allowPalletRotate,
    unit, boxColor, boxKraft, colorPreset, modelName, partName
  };
}
function validateInputs(F) {
  let arr = [];
  if(F.bw <=0 || F.bl<=0 || F.bh<=0) arr.push("กรุณากรอกขนาดกล่องให้ถูกต้อง");
  if(F.pw <=0 || F.pl<=0) arr.push("กรุณากรอกขนาดพาเลทให้ถูกต้อง");
  if(F.tw <=0 || F.tl<=0 || F.th<=0) arr.push("กรุณากรอกขนาดรถให้ถูกต้อง");
  if((F.bw>F.pw && F.bl>F.pl) && (F.bl>F.pw && F.bw>F.pl)) arr.push("กล่องใหญ่กว่าพาเลทในทุกทิศทาง");
  if(F.stackType=="maxh"&& F.maxHeight<F.pb+F.bh) arr.push("Max Height ต้องมากกว่าฐานพาเลท+สูงกล่อง");
  if(F.stackType=="layer"&& F.boxLayers<=0) arr.push("จำนวนชั้นกล่องต้องมากกว่า 0");
  return arr;
}
// ---- Pallet Calculation ----
function computePallet(F){
  // กล่องต่อชั้น
  let nNoRotate = Math.floor(F.pw/F.bw) * Math.floor(F.pl/F.bl); // ไม่หมุน
  let nRotate = Math.floor(F.pw/F.bl) * Math.floor(F.pl/F.bw); // หมุน
  let orientation = "ไม่หมุน";
  let boxesPerLayer = nNoRotate, boxLayerW=F.bw, boxLayerL=F.bl;
  if(F.allowBoxRotate){
    if(nRotate>nNoRotate){
      boxesPerLayer = nRotate; orientation = "หมุน";
      boxLayerW=F.bl; boxLayerL=F.bw;
    }
  }
  // จำนวนชั้น (กล่อง)
  let maxLayers = 1;
  if(F.stackType==="maxh"){
    maxLayers = Math.floor((F.maxHeight-F.pb)/F.bh); 
    if(maxLayers<1) maxLayers = 0;
  }
  else maxLayers = F.boxLayers;
  let boxesPerPallet = boxesPerLayer*maxLayers;
  let palletWeight = F.ptw + (boxesPerPallet*F.bwgt);
  let palletTotalHeight = F.pb + (maxLayers*F.bh);
  return { boxesPerLayer, orientation, boxLayerW, boxLayerL, maxLayers,boxesPerPallet, palletWeight, palletTotalHeight };
}
// ---- Truck Calculation ----
function computeTruck(F, P){
  // พาเลทต่อชั้นบนรถ
  let mNoRotate = Math.floor(F.tw/F.pw)*Math.floor(F.tl/F.pl);
  let mRotate = Math.floor(F.tw/F.pl)*Math.floor(F.tl/F.pw);
  let orientation = "ไม่หมุน";
  let palletsPerLayer=mNoRotate, palletFitW=F.pw, palletFitL=F.pl;
  if(F.allowPalletRotate){
    if(mRotate>mNoRotate){
      palletsPerLayer = mRotate; orientation="หมุน";
      palletFitW=F.pl; palletFitL=F.pw;
    }
  }
  // จำนวนชั้นพาเลท
  let maxTruckLayers = F.allowPalletStack ?
    Math.min(F.truckMaxPalletLayers, Math.floor(F.th/P.palletTotalHeight)) :
    Math.min(1, Math.floor(F.th/P.palletTotalHeight));
  let palletsOnTruck = palletsPerLayer*maxTruckLayers;
  let totalTruckWeight = palletsOnTruck*P.palletWeight;
  let heightLeft = F.th - (maxTruckLayers*P.palletTotalHeight);
  return { palletsPerLayer, orientation, palletFitW,palletFitL,maxTruckLayers,palletsOnTruck,totalTruckWeight,heightLeft };
}
// ---- Rendering ----
function setReport(html){ document.getElementById("outputArea").innerHTML=html; }
function rUnit(v,u){ return u=="cm"?round2(cm(v))+" cm":v+" mm"; }
function renderReport(F,P,T){
  let info=`<div class="card"><h2>ผลลัพธ์</h2>`;
  if(F.modelName) info+=`<div style="font-weight:700">Model: ${F.modelName}</div>`;
  if(F.partName) info+=`<div style="font-weight:700">Part: ${F.partName}</div>`;

  info+=`<ul>
    <li><b>พาเลท:</b> กล่องต่อชั้น: ${P.boxesPerLayer} (แนว: ${P.orientation}), ชั้นทั้งหมด: ${P.maxLayers}, กล่องต่อพาเลท: ${P.boxesPerPallet}
    <li>น้ำหนักพาเลท (kg): <b>${round2(P.palletWeight)}</b>, ความสูงพาเลทรวม: <b>${rUnit(P.palletTotalHeight,F.unit)}</b></li>
    <li><b>รถบรรทุก:</b> พาเลทต่อชั้น: ${T.palletsPerLayer} (แนว: ${T.orientation}), ชั้นพาเลท: ${T.maxTruckLayers}, รวมพาเลท: ${T.palletsOnTruck}</li>
    <li>น้ำหนักรวมบรรทุก (kg): <b>${round2(T.totalTruckWeight)}</b> &middot; เหลือพื้นที่สูง: ${rUnit(T.heightLeft,F.unit)}</li>
  </ul></div>`;
  return info;
}
// ---- Simulation SVGs ----
let currentView="top";
document.querySelectorAll(".viewbtn").forEach(btn=>{
  btn.onclick = function(){
    currentView = btn.getAttribute("data-v");
    document.querySelectorAll(".viewbtn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    renderAll();
  }
});
function renderSim(F,P,T){
  // get color set
  const cp = COLOR_PRESETS[F.colorPreset];
  let boxFill = F.boxKraft ? "#b08e62" : F.boxColor, // kraft override
   palletFill = cp.pallet, truckFill = cp.truck, stroke=cp.stroke,
   bg = document.documentElement.getAttribute("data-theme")==="dark"?cp.bgdk:cp.bglt;
  // SVG
  let svg = document.getElementById("palletSvg");
  let w = svg.width.baseVal.value, h = svg.height.baseVal.value;
  svg.innerHTML = ""; 
  svg.style.background = bg;
  // scaling factors
  let pW = F.pw, pL=F.pl, pB=F.pb, bW=P.boxLayerW, bL=P.boxLayerL, bH=F.bh, nB=P.boxesPerLayer, nL=P.maxLayers;
  let margin=32, Z=clamp(parseFloat(document.getElementById("zoomSlider").value)||1,0.5,2.5);

  // Helper for dimension lines
  function dimLine(x1,y1,x2,y2,label,side){
    let midx=(x1+x2)/2, midy=(y1+y2)/2+((side=="t")?-11:13);
    return `<line class="dimline" x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"/><text class="dimlabel" x="${midx}" y="${midy}">${label}</text>`;
  }
  // Views
  let simLabel = "";
  if(currentView==="top"){ // พื้น + กล่องบนพาเลท (1 ชั้น)
    let scale = Math.min((w-2*margin)/pW, (h-2*margin)/pL)*Z;
    let ox=margin, oy=margin;
    let boxes=[];
    let nW=Math.floor(pW/bW), nL2=Math.floor(pL/bL);
    for(let i=0;i<nW;i++) for(let j=0;j<nL2;j++)
      boxes.push({x:ox+i*bW*scale, y:oy+j*bL*scale, w:bW*scale, h:bL*scale});
    // พื้น
    svg.innerHTML += `<rect x="${ox}" y="${oy}" width="${pW*scale}" height="${pL*scale}" fill="${palletFill}" stroke="${stroke}" stroke-width="2"/>`;
    // กล่อง
    for(const b of boxes)
      svg.innerHTML += `<rect x="${b.x}" y="${b.y}" width="${b.w-1}" height="${b.h-1}" fill="${boxFill}" stroke="${stroke}" stroke-width="1.1"/>`;
    // Dim lines
    svg.innerHTML += dimLine(ox,oy+pL*scale+7, ox+pW*scale,oy+pL*scale+7, rUnit(pW,F.unit),'b');
    svg.innerHTML += dimLine(ox-7,oy, ox-7,oy+pL*scale, rUnit(pL,F.unit),'l');
    simLabel = "Top View: Pallet + Boxes";
  }
  else if(currentView==="front"){ // หน้า
    let scale = Math.min((w-2*margin)/pW, (h-2*margin)/(F.pb+P.maxLayers*bH))*Z;
    let ox=margin, oy=margin;
    svg.innerHTML += `<rect x="${ox}" y="${oy+P.maxLayers*bH*scale}" width="${pW*scale}" height="${F.pb*scale}" fill="${palletFill}" stroke="${stroke}" stroke-width="2"/>`;
    for(let l=0;l<P.maxLayers;l++){
      svg.innerHTML += `<rect x="${ox}" y="${oy+(P.maxLayers-l-1)*bH*scale}" width="${pW*scale}" height="${bH*scale}" fill="${boxFill}" stroke="${stroke}" stroke-width="1.1"/>`;
      svg.innerHTML += `<line x1="${ox}" y1="${oy+(P.maxLayers-l-1)*bH*scale}" x2="${ox+pW*scale}" y2="${oy+(P.maxLayers-l-1)*bH*scale}" stroke="#c77f00" stroke-width="0.75" opacity="0.3"/>`;
    }
    svg.innerHTML += dimLine(ox+pW*scale+7, oy, ox+pW*scale+7, oy+P.maxLayers*bH*scale, `${P.maxLayers} ชั้น`,'r');
    svg.innerHTML += dimLine(ox-13, oy, ox-13, oy+(P.maxLayers*bH+F.pb)*scale, rUnit(P.palletTotalHeight,F.unit),'l');
    simLabel = "Front View";
  }
  else if(currentView==="side"){ // ด้านข้างยาว
    let scale = Math.min((w-2*margin)/pL, (h-2*margin)/(F.pb+P.maxLayers*bH))*Z;
    let ox=margin, oy=margin;
    svg.innerHTML += `<rect x="${ox}" y="${oy+P.maxLayers*bH*scale}" width="${pL*scale}" height="${F.pb*scale}" fill="${palletFill}" stroke="${stroke}" stroke-width="2"/>`;
    for(let l=0;l<P.maxLayers;l++){
      svg.innerHTML += `<rect x="${ox}" y="${oy+(P.maxLayers-l-1)*bH*scale}" width="${pL*scale}" height="${bH*scale}" fill="${boxFill}" stroke="${stroke}" stroke-width="1.1"/>`;
    }
    svg.innerHTML += dimLine(ox, oy+pL*scale+7, ox+pL*scale, oy+pL*scale+7, rUnit(pL,F.unit),'b');
    svg.innerHTML += dimLine(ox-12, oy, ox-12, oy+(P.maxLayers*bH+F.pb)*scale, rUnit(P.palletTotalHeight,F.unit),'l');
    simLabel = "Side View";
  }
  else if(currentView==="iso"){ // Isometric View
    let scale = Math.min((w-2*margin)/pW, (h-2*margin)/((F.pb+P.maxLayers*bH)*0.7))*Z*0.7;
    let ox=w/2-pW*scale/2, oy=margin+110;
    // Pallet base, orthogonal 3D
    for(let l=0;l<=P.maxLayers;l++){
      let y=oy-l*bH*scale*0.5;
      svg.innerHTML += `<polygon points="${ox},${y+F.pb*scale*0.4} ${ox+pW*scale},${y+F.pb*scale*0.4} ${ox+pW*scale*0.85},${y} ${ox+pW*scale*0.15},${y}" fill="${l==0?palletFill:boxFill}" stroke="${stroke}" stroke-width="1.3" opacity="${l==0?1:0.8}"/>`;
    }
    simLabel = "Isometric View";
  }
  document.getElementById("simLabels").innerHTML = simLabel + 
    (F.modelName?" | <b>Model:</b> "+F.modelName:"") +
    (F.partName?" | <b>Part:</b> "+F.partName :"");
}
// ---- Export ----
document.getElementById("exportJsonBtn").onclick = function(){
  const F=parseInputs(),P=computePallet(F),T=computeTruck(F,P);
  const out={inputs:F, pallet:P, truck:T, ts:new Date().toISOString()};
  downloadBlob(JSON.stringify(out,null,2),"pallet-sim.json","application/json");
};
function downloadBlob(data, fname, type) {
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([data], {type}));
  a.download=fname; a.click();
}
document.getElementById("exportSvgBtn").onclick = function(){
  let svg=document.getElementById("palletSvg").outerHTML;
  downloadBlob(svg,"pallet-sim.svg","image/svg+xml");
};
// ---- Zoom Slider ----
document.getElementById("zoomSlider").oninput = renderAll;

setTimeout(()=>renderAll(),150);
</script>
</body>
</html>
